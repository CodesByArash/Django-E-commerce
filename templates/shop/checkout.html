{% extends 'shop/base.html' %}
{% load static %}

{% block title %}تکمیل خرید{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'shop/checkout.css' %}">
<style>
    .checkout-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 1rem;
    }
    
    .card {
        border: none;
        box-shadow: 0 0 15px rgba(0,0,0,0.1);
        margin-bottom: 1.5rem;
        background-color: #fff;
        border-radius: 8px;
    }
    
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #eee;
        padding: 1rem 1.5rem;
        border-radius: 8px 8px 0 0;
    }
    
    .card-header h4 {
        margin: 0;
        color: #333;
        font-weight: 600;
        font-size: 1.25rem;
    }
    
    .card-body {
        padding: 1.5rem;
    }
    
    .table {
        margin-bottom: 0;
        width: 100%;
    }
    
    .table th {
        border-top: none;
        font-weight: 600;
        color: #555;
        padding: 1rem;
        background-color: #f8f9fa;
    }
    
    .table td {
        vertical-align: middle;
        padding: 1rem;
        border-bottom: 1px solid #eee;
    }
    
    .product-image {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 6px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .quantity-input {
        width: 80px !important;
        text-align: center;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 0.5rem;
        font-size: 0.9rem;
    }
    
    .quantity-input:focus {
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
        outline: none;
    }
    
    .btn-remove {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        background-color: #dc3545;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        min-width: 100px;
    }
    
    .btn-remove:hover {
        background-color: #c82333;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(220, 53, 69, 0.2);
    }
    
    .btn-remove:active {
        transform: translateY(0);
    }
    
    .btn-update {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-left: 0.5rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        min-width: 100px;
    }
    
    .btn-update:hover {
        background-color: #218838;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(40, 167, 69, 0.2);
    }
    
    .btn-update:active {
        transform: translateY(0);
    }
    
    .action-buttons {
        display: flex;
        gap: 0.5rem;
        justify-content: flex-start;
        align-items: center;
    }
    
    .form-label {
        font-weight: 500;
        color: #555;
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
    }
    
    .form-control {
        border: 1px solid #ddd;
        padding: 0.75rem;
        border-radius: 4px;
        font-size: 0.95rem;
        transition: all 0.3s ease;
    }
    
    .form-control:focus {
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
        outline: none;
    }
    
    .btn-checkout {
        background-color: #007bff;
        border: none;
        padding: 0.75rem 1.5rem;
        font-weight: 500;
        font-size: 1rem;
        border-radius: 4px;
        transition: all 0.3s ease;
        width: 100%;
    }
    
    .btn-checkout:hover {
        background-color: #0056b3;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .alert {
        border: none;
        border-radius: 6px;
        padding: 1rem 1.5rem;
        margin-bottom: 1rem;
        font-size: 0.95rem;
    }
    
    .alert-info {
        background-color: #e3f2fd;
        color: #0c5460;
    }
    
    .alert-warning {
        background-color: #fff3cd;
        color: #856404;
    }
    
    .total-price {
        font-size: 1.25rem;
        color: #28a745;
        font-weight: 600;
    }
    
    .product-title {
        font-weight: 500;
        color: #333;
        font-size: 1rem;
        margin-right: 1rem;
    }
    
    .product-price {
        color: #666;
        font-size: 0.95rem;
    }
    
    .checkout-summary {
        background-color: #f8f9fa;
        padding: 1.25rem;
        border-radius: 6px;
        margin-top: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .checkout-summary-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.75rem;
        color: #666;
        font-size: 0.95rem;
    }
    
    .checkout-summary-total {
        border-top: 1px solid #ddd;
        margin-top: 0.75rem;
        padding-top: 0.75rem;
        font-weight: 600;
        color: #333;
        font-size: 1.1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="checkout-container">
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}
    
    {% if cart_items %}
        <div class="row">
            <div class="col-md-8">
                <!-- Cart Items -->
                <div class="card">
                    <div class="card-header">
                        <h4>سبد خرید</h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>تصویر</th>
                                        <th>نام محصول</th>
                                        <th>قیمت</th>
                                        <th>تعداد</th>
                                        <th>عملیات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in cart_items %}
                                        <tr>
                                            <td>
                                                {% if item.product.image %}
                                                    <img src="{{ item.product.image.url }}" class="product-image" alt="{{ item.product.title }}">
                                                {% else %}
                                                    <img src="{% static 'shop/images/no-image.png' %}" class="product-image" alt="بدون تصویر">
                                                {% endif %}
                                            </td>
                                            <td>
                                                <a href="{% url 'shop:detail' item.product.id %}" class="product-title">{{ item.product.title }}</a>
                                            </td>
                                            <td class="product-price">{{ item.product.price|floatformat:0 }} تومان</td>
                                            <td>
                                                <input type="number" class="form-control quantity-input" 
                                                       value="{{ item.quantity }}" min="1" 
                                                       data-item-id="{{ item.id }}" 
                                                       onchange="updateQuantity(this)">
                                            </td>
                                            <td>
                                                <div class="action-buttons">
                                                    <button class="btn btn-update" onclick="updateCartItem({{ item.product.id }})">
                                                        <i class="fas fa-sync-alt"></i>
                                                        بروزرسانی
                                                    </button>
                                                    <button class="btn btn-remove" onclick="removeCartItem({{ item.product.id }})">
                                                        <i class="fas fa-trash"></i>
                                                        حذف
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Shipping Information -->
                <div class="card">
                    <div class="card-header">
                        <h4>اطلاعات ارسال</h4>
                    </div>
                    <div class="card-body">
                        <form method="post" id="checkout-form">
                            {% csrf_token %}
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="full_name" class="form-label">نام و نام خانوادگی</label>
                                    <input type="text" class="form-control" id="full_name" name="full_name" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="phone" class="form-label">شماره تماس</label>
                                    <input type="tel" class="form-control" id="phone" name="phone" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label for="address" class="form-label">آدرس کامل</label>
                                    <textarea class="form-control" id="address" name="address" rows="3" required></textarea>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="city" class="form-label">شهر</label>
                                    <input type="text" class="form-control" id="city" name="city" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="postal_code" class="form-label">کد پستی</label>
                                    <input type="text" class="form-control" id="postal_code" name="postal_code" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label for="notes" class="form-label">توضیحات (اختیاری)</label>
                                    <textarea class="form-control" id="notes" name="notes" rows="2"></textarea>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <!-- Order Summary -->
                <div class="card">
                    <div class="card-header">
                        <h4>خلاصه سفارش</h4>
                    </div>
                    <div class="card-body">
                        <div class="checkout-summary">
                            <div class="checkout-summary-item">
                                <span>تعداد محصولات:</span>
                                <span>{{ cart.get_total_items }} عدد</span>
                            </div>
                            <div class="checkout-summary-item">
                                <span>جمع کل:</span>
                                <span class="total-price">{{ cart.get_total_price|floatformat:0 }} تومان</span>
                            </div>
                            <div class="checkout-summary-item">
                                <span>هزینه ارسال:</span>
                                <span>رایگان</span>
                            </div>
                            <div class="checkout-summary-total">
                                <span>مبلغ قابل پرداخت:</span>
                                <span>{{ cart.get_total_price|floatformat:0 }} تومان</span>
                            </div>
                        </div>
                        
                        {% if is_cart_empty %}
                            <div class="alert alert-warning mb-3">
                                <i class="fas fa-exclamation-triangle"></i>
                                سبد خرید شما خالی است. لطفاً ابتدا محصولی به سبد خرید اضافه کنید.
                            </div>
                            <button class="btn btn-checkout" disabled>
                                <i class="fas fa-credit-card"></i>
                                ادامه فرآیند خرید
                            </button>
                        {% else %}
                            <button type="submit" class="btn btn-checkout">
                                <i class="fas fa-credit-card"></i>
                                ادامه فرآیند خرید
                            </button>
                        {% endif %}
                        
                        <a href="{% url 'shop:index' %}" class="btn btn-outline-secondary w-100 mt-3">
                            <i class="fas fa-arrow-right"></i>
                            بازگشت به فروشگاه
                        </a>
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            سبد خرید شما خالی است.
        </div>
        <a href="{% url 'shop:index' %}" class="btn btn-primary">
            <i class="fas fa-shopping-cart"></i>
            مشاهده محصولات
        </a>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    // Setup CSRF token for all AJAX requests
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Setup AJAX CSRF token
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
            }
        }
    });

    // Test function to check if endpoints are working
    function testCartEndpoints() {
        // Test update endpoint
        fetch("{% url 'shop:update_cart' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                product_id: 1,
                quantity: 1
            })
        })
        .then(response => response.json())
        .then(data => console.log('Update test response:', data))
        .catch(error => console.error('Update test error:', error));

        // Test remove endpoint
        fetch("{% url 'shop:remove_from_cart' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                product_id: 1
            })
        })
        .then(response => response.json())
        .then(data => console.log('Remove test response:', data))
        .catch(error => console.error('Remove test error:', error));
    }

    // Run test when page loads
    document.addEventListener('DOMContentLoaded', testCartEndpoints);

    function updateCartItem(productId, quantity) {
        if (!quantity) {
            quantity = document.querySelector(`input[data-item-id="${productId}"]`).value;
        }
        console.log('Updating cart item:', { productId, quantity });
        $.ajax({
            url: '{% url "shop:update_cart" %}',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                product_id: productId,
                quantity: parseInt(quantity)
            }),
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {
                console.log('Update response:', response);
                if (response.status === 'success') {
                    showMessage(response.message, 'success');
                    if (response.cart_total !== undefined) {
                        $('.total-price').text(response.cart_total.toLocaleString() + ' تومان');
                    }
                    if (response.cart_count !== undefined) {
                        $('.cart-count').text(response.cart_count);
                    }
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showMessage(response.message || 'خطا در بروزرسانی سبد خرید', 'error');
                }
            },
            error: function(xhr, status, error) {
                console.error('Update error:', { xhr, status, error });
                let errorMessage = 'خطا در ارتباط با سرور';
                try {
                    const response = xhr.responseJSON;
                    if (response && response.message) {
                        errorMessage = response.message;
                    } else if (xhr.responseText) {
                        errorMessage = xhr.responseText;
                    }
                } catch (e) {
                    console.error('Error parsing response:', e);
                }
                showMessage(errorMessage, 'error');
            }
        });
    }
    
    function removeCartItem(productId) {
        console.log('Removing cart item:', productId);
        if (!confirm('آیا از حذف این محصول از سبد خرید اطمینان دارید؟')) {
            return;
        }
        
        const requestData = {
            product_id: productId
        };
        console.log('Request data:', requestData);
        
        $.ajax({
            url: '{% url "shop:remove_from_cart" %}',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(requestData),
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest'
            },
            beforeSend: function(xhr) {
                console.log('Request headers:', xhr.getAllResponseHeaders());
                console.log('Request URL:', this.url);
                console.log('Request method:', this.method);
                console.log('Request data:', this.data);
            },
            success: function(response) {
                console.log('Remove response:', response);
                if (response.status === 'success') {
                    showMessage(response.message, 'success');
                    if (response.cart_total !== undefined) {
                        $('.total-price').text(response.cart_total.toLocaleString() + ' تومان');
                    }
                    if (response.cart_count !== undefined) {
                        $('.cart-count').text(response.cart_count);
                    }
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showMessage(response.message || 'خطا در حذف محصول از سبد خرید', 'error');
                }
            },
            error: function(xhr, status, error) {
                console.error('Remove error details:', {
                    status: status,
                    error: error,
                    responseText: xhr.responseText,
                    statusText: xhr.statusText,
                    statusCode: xhr.status
                });
                let errorMessage = 'خطا در ارتباط با سرور';
                try {
                    const response = xhr.responseJSON;
                    if (response && response.message) {
                        errorMessage = response.message;
                    } else if (xhr.responseText) {
                        errorMessage = xhr.responseText;
                    }
                } catch (e) {
                    console.error('Error parsing response:', e);
                }
                showMessage(errorMessage, 'error');
            }
        });
    }

    function showMessage(message, type = 'info') {
        const messageDiv = document.createElement('div');
        messageDiv.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show`;
        messageDiv.style.position = 'fixed';
        messageDiv.style.top = '20px';
        messageDiv.style.left = '50%';
        messageDiv.style.transform = 'translateX(-50%)';
        messageDiv.style.zIndex = '9999';
        messageDiv.style.minWidth = '300px';
        messageDiv.style.textAlign = 'center';
        messageDiv.style.padding = '15px';
        messageDiv.style.borderRadius = '5px';
        messageDiv.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
        
        const closeButton = document.createElement('button');
        closeButton.type = 'button';
        closeButton.className = 'btn-close';
        closeButton.setAttribute('data-bs-dismiss', 'alert');
        closeButton.setAttribute('aria-label', 'Close');
        
        messageDiv.appendChild(document.createTextNode(message));
        messageDiv.appendChild(closeButton);
        
        document.body.appendChild(messageDiv);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            messageDiv.classList.remove('show');
            setTimeout(() => messageDiv.remove(), 150);
        }, 5000);
    }
</script>
{% endblock %}